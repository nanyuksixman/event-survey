<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë²¤íŠ¸ ì°¸ì—¬</title>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; text-align: center; padding-top: 30px; background-color: #f9f9f9; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h2 { color: #333; margin-bottom: 20px; }
        
        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        input { padding: 12px; font-size: 16px; width: 80%; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
        
        button { background-color: #4a90e2; color: white; border: none; padding: 15px 0; font-size: 18px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .code-box { background: #fff5f5; padding: 15px; border: 2px dashed #ff6b6b; border-radius: 10px; color: #ff6b6b; font-weight: bold; font-size: 24px; margin-top: 20px; display: none; }
        .step { display: none; }
        .step.active { display: block; }
    </style>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() { emailjs.init("1eClXvyi7Cegunx5J"); })(); // íšŒì›ë‹˜ Key
    </script>
</head>
<body>
    <div class="container">
        
        <div id="step1" class="step active">
            <h2>ğŸ í–‰ìš´ê¶Œ ì¶”ì²¨</h2>
            <p>ì„¤ë¬¸ì— ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.<br>ê¸°íšŒëŠ” ë‹¨ í•œ ë²ˆì…ë‹ˆë‹¤!</p>
            <button onclick="tryLucky()" id="btnStart">ğŸ² ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
        </div>

        <div id="step2" class="step">
            <h2 style="color:#4a90e2">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
            <p>ê²½í’ˆ ì§€ê¸‰ì„ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>(íƒ€ì¸ì—ê²Œ ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)</p>
            
            <input type="text" id="dept" placeholder="ë¶€ì„œëª… (ì˜ˆ: í…Œí¬ê·¸ë£¹)">
            <input type="text" id="name" placeholder="ì„±í•¨ (ì˜ˆ: ê¹€êµ­ë¯¼)">
            
            <button onclick="submitInfo()">ì…ë ¥ ì™„ë£Œ</button>
        </div>

        <div id="step3" class="step">
            <h2>í™•ì¸ ì¤‘...</h2>
            <p>ì„ ì°©ìˆœ(30ëª…) ë§ˆê° ì—¬ë¶€ë¥¼<br>ì‹¤ì‹œê°„ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤.</p>
            <div style="font-size:30px;">â³</div>
        </div>

        <div id="step4" class="step">
            <h2 id="finalTitle"></h2>
            <div id="finalMsg"></div>
            <div id="winCode" class="code-box"></div>
        </div>
    </div>

    <script>
        // ============================================================
        // [ì„¤ì • 1] ì¹´ìš´í„° ì •ë³´ (CountAPI) - ì•„ê¹Œ ë§Œë“  ê±° ê·¸ëŒ€ë¡œ ì“°ì„¸ìš”!
        var counterNamespace = "my_lucky_event"; 
        var counterKey = "winner_count";         

        // [ì„¤ì • 2] í–‰ìš´ì˜ ë¶„ (ë§¤ ì‹œê°„ 0~59ë¶„ ì¤‘ ë‹¹ì²¨ ê°€ëŠ¥í•œ ë¶„)
        var luckyMinutes = [10, 20, 30, 40, 50, 0]; 
        
        // [ì„¤ì • 3] ë‹¹ì²¨ì ì œí•œ ìˆ˜ (30ëª…)
        var maxWinners = 30;
        
        // [ì„¤ì • 4] í™•ë¥  (í…ŒìŠ¤íŠ¸ í›„ 1/30 ë¡œ ë³€ê²½)
        var baseWinRate = 1/30; 
        // ============================================================
        
        var generatedCode = "";
        var userDept = "";
        var userName = "";

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¤‘ë³µ ì°¸ì—¬ ì²´í¬
        window.onload = function() {
            if (localStorage.getItem('hasPlayed') === 'yes') {
                alert("ì´ë¯¸ ì¶”ì²¨ì— ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤. âœ‹");
                document.getElementById('step1').innerHTML = "<h2>ì°¸ì—¬ ì™„ë£Œ</h2><p>ì´ë¯¸ ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤.<br>ê°ì‚¬í•©ë‹ˆë‹¤.</p>";
            }
        }

        function tryLucky() {
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnStart').innerText = "í™•ì¸ ì¤‘...";
            
            // "ì°¸ì—¬í•¨" ë„ì¥ ì°ê¸°
            localStorage.setItem('hasPlayed', 'yes');

            setTimeout(function() {
                var currentMinute = new Date().getMinutes();
                var isLuckyTime = luckyMinutes.includes(currentMinute);
                
                // 1ì°¨ ì¶”ì²¨ (ì‹œê°„ + í™•ë¥ )
                if (isLuckyTime && Math.random() < baseWinRate) {
                    // 1ì°¨ ë‹¹ì²¨ -> ì •ë³´ ì…ë ¥ í™”ë©´ìœ¼ë¡œ ì´ë™
                    changeStep(2);
                } else {
                    // ê½ -> ì¢…ë£Œ
                    showResult("ì•„ì‰½ë„¤ìš” ğŸ˜­", "ë‹¹ì²¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.", false);
                }
            }, 1000);
        }

        function submitInfo() {
            var deptInput = document.getElementById('dept').value;
            var nameInput = document.getElementById('name').value;

            if (deptInput.length < 1 || nameInput.length < 1) {
                return alert("ë¶€ì„œì™€ ì„±í•¨ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }

            userDept = deptInput;
            userName = nameInput;

            // ì •ë³´ ì…ë ¥ í›„ ì¹´ìš´í„° í™•ì¸í•˜ëŸ¬ ì´ë™
            changeStep(3);
            checkCounterLimit();
        }

        // CountAPI í™•ì¸ ë° ì´ë©”ì¼ ì „ì†¡
        function checkCounterLimit() {
            // ìˆ«ì 1 ì˜¬ë¦¬ë©´ì„œ(hit) í˜„ì¬ ê°’ ê°€ì ¸ì˜¤ê¸°
            var apiUrl = "https://api.countapi.xyz/hit/" + counterNamespace + "/" + counterKey;

            fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                var currentCount = data.value; // í˜„ì¬ ë‹¹ì²¨ì ìˆ˜

                if (currentCount <= maxWinners) {
                    // [ìµœì¢… ë‹¹ì²¨]
                    generatedCode = Math.random().toString(36).substr(2, 6).toUpperCase();
                    
                    // ë©”ì¼ ë°œì†¡ ë‚´ìš© ìˆ˜ì •ë¨ (ë¶€ì„œ/ì„±í•¨ í¬í•¨)
                    var params = { 
                        message: "ë¶€ì„œ: " + userDept + " / ì„±í•¨: " + userName + " / ì½”ë“œ: " + generatedCode + " / ìˆœë²ˆ: " + currentCount + "ë“±" 
                    };
                    
                    emailjs.send('service_yzbru09', 'template_ynu7hlo', params);
                    
                    showResult("ğŸ‰ ìµœì¢… ë‹¹ì²¨!", "ì¶•í•˜í•©ë‹ˆë‹¤! <b>" + currentCount + "ë²ˆì§¸</b> ë‹¹ì²¨ìì…ë‹ˆë‹¤.<br>ì•„ë˜ ì½”ë“œë¥¼ ìº¡ì²˜í•´ì£¼ì„¸ìš”.", true);
                } else {
                    // [ë§ˆê°]
                    showResult("ì„ ì°©ìˆœ ë§ˆê°", "ì•„ì‰½ê²Œë„ 30ëª…ì´ ëª¨ë‘ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", false);
                }
            })
            .catch(error => {
                // API ì—ëŸ¬ ì‹œ ì•ˆì „í•˜ê²Œ ê½ ì²˜ë¦¬
                console.log(error);
                showResult("ì ‘ì† í­ì£¼", "ì¼ì‹œì ì¸ ì˜¤ë¥˜ë¡œ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", false);
            });
        }

        function showResult(title, msg, isWin) {
            changeStep(4);
            document.getElementById('finalTitle').innerText = title;
            document.getElementById('finalMsg').innerHTML = msg;
            if (isWin) {
                var box = document.getElementById('winCode');
                box.innerText = generatedCode;
                box.style.display = 'block';
            }
        }

        function changeStep(num) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + num).classList.add('active');
        }
    </script>
</body>
</html>
